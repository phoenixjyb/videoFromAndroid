camControl — Project Diary

Overview
- Goal: Android Camera2 remote camera with on-device H.264 encoding and a lightweight WebSocket control/telemetry + browser viewer.
- Topology: Android phone runs camera + encoder + Ktor WS server. Desktop browser connects over LAN/ADB, decodes H.264 in JS, sends control commands, and receives telemetry.
- Target device: SM‑S9160 (Galaxy S23+). Back logical camera ID 0 (physical IDs [2,5,6]); LEVEL_3; supports MANUAL_SENSOR, LOGICAL_MULTI_CAMERA, CONSTRAINED_HIGH_SPEED_VIDEO, DYNAMIC_RANGE_TEN_BIT.

Project Structure
- Root Kotlin sources (reference):
  - `Camera2Controller.kt` — Camera device/session management, repeating request, zoom, AE/AWB lock, telemetry callback.
  - `VideoEncoder.kt` — MediaCodec H.264 encoder using input surface, outputs Annex B, prepends SPS/PPS for IDR.
  - `ControlServer.kt` — Ktor WS server, broadcasts binary video and text telemetry.
  - `ControlCommand.kt` — Sealed commands (`setZoomRatio`, `setAeLock`, `setAwbLock`).
  - `Telemetry.kt` — Telemetry payload (AF/AE/ISO/exp/zoom/fps).
  - `MainActivity.kt` — App wiring: permissions, preview, encoder start, command handling, telemetry broadcast.
  - `activity_main.xml` — Fullscreen `SurfaceView` preview.
  - `index.html` — Web client with Broadway H.264 decoder, controls, telemetry panel.
- Android Gradle project (for building from VS Code/Studio):
  - `app/src/main/java/com/example/camcontrol/...` — Module copies of the above sources for build.
  - `app/src/main/res/layout/activity_main.xml` — Layout.
  - `app/src/main/AndroidManifest.xml` — CAMERA/INTERNET, launcher activity.
  - Gradle files: `settings.gradle.kts`, `build.gradle.kts`, `app/build.gradle.kts`.
  - VS Code: `.vscode/tasks.json` (wrapper, assembleDebug, installDebug, ADB forward).

What Works Now
- Camera2 pipeline: opens back camera, creates session with preview + encoder surfaces, AF/AE/AWB ON, 30 fps.
- Camera selection: Prefers logical back camera ID "0" for smooth zoom across lenses. Enables OIS (EIS off by default to avoid FOV crop).
- Encoding: H.264 (AVC) at 1080p30, 8 Mbps; outputs Annex B NAL units and prepends SPS/PPS on keyframes.
- Transport: Ktor WS server (`ws://<phone>:8080/control`) sends binary video frames and text telemetry; accepts JSON control.
- Controls: Zoom slider; AE Lock, AWB Lock toggles.
- Telemetry: AF/AE states, ISO, exposure time, zoom, smoothed FPS at ~10 Hz; displayed in browser.
- Build: Android Gradle project compiles from VS Code. Installable via `./gradlew installDebug`.
- Recording: Start/Stop commands record MP4 files (video-only) into app Movies directory using MediaMuxer, while streaming continues.

Networking Notes (VPN/Clash)
- Prefer `adb forward tcp:8080 tcp:8080` to bypass VPN/proxy. Then set `ANDROID_IP` to `127.0.0.1` in `index.html`.
- If using LAN IP, ensure Clash bypass for private subnets (10/8, 172.16/12, 192.168/16) and `.local` domains.

Known Limitations / Next
- Broadway (JS H.264) is CPU-heavy; consider WebRTC or MediaMTX/LL-HLS for efficiency.
- Error handling/recovery on camera disconnects is minimal.
- Manual exposure/focus controls not yet implemented.
- No persistence of settings across runs.
- Recording is video-only (no audio). Filename is autogenerated; optional name hint supported via command.

Short Roadmap
1) Manual exposure/focus controls (exposure time/ISO, tap-to-focus) + UI sliders.
2) Audio capture + mux into MP4; optional streaming (AAC over WS or move to WebRTC).
3) Error handling + auto-recovery (device/session callbacks).
4) Web client polish (auto device discovery, FPS indicator, keyboard shortcuts).
5) Optional: WebRTC publisher or RTSP/SRT to MediaMTX on Jetson.

Log (Recent Changes)
- Added Gradle Android scaffold and VS Code tasks for local builds.
- Implemented Annex B conversion + SPS/PPS prefixing and proper input surface handling.
- Made Ktor server non-blocking; added text broadcast API.
- Added telemetry capture in Camera2 via CaptureCallback; JSON broadcast at ~10 Hz.
- Hardened web client to separate text vs binary; added telemetry panel.
- Added AE/AWB lock controls and command handling end-to-end.
- Added MP4 recording via MediaMuxer; start/stop commands; UI button.

2025-09-12 — Unified WS 9090, browser streaming fixed, capture tools
- Unified networking on port 9090 end-to-end (server, UI, tests). Ktor binds 0.0.0.0.
- Split responsibilities: Service runs the WebSocket server and encoder; Activity owns camera operations. Commands use explicit broadcasts.
- Video streaming: Service broadcasts encoder Surface; Activity attaches it to capture session alongside preview. Binary H.264 frames are broadcast to WS clients.
- Telemetry path: Activity encodes telemetry JSON and broadcasts to Service; Service forwards as WS text frames.
- Web UI: Added WebCodecs-based H.264 decoding with Annex‑B→AVCC conversion and SPS/PPS config. Falls back to Broadway if unavailable. Decoder reset logic handles errors and reconnects.
- Dev tools: Added scripts to test and debug
  - `scripts/ws_probe.py` — quick binary/text probe
  - `scripts/ws_save_h264.py` — save WS H.264 to file (waits for SPS/IDR), remux externally
  - `scripts/ws_record.py` — trigger on-device MP4 record via WS
  - `scripts/log.sh` — updated to forward 9090
  - `scripts/webui.sh` — updated defaults for 9090
- Tests: Updated WebSocket test scripts to 9090 and made them proxy-robust.
- Housekeeping: Added `/assets` route in Ktor to serve local UI assets; removed root duplicates; expanded .gitignore to exclude captures.

2025-09-13 — Android Sprint 1 plan + kickoff
- Goals (Android‑first toward production):
  1) Fast recovery + predictability during reconfigure
     - Force keyframe on demand and after reconfigure (DONE: requestKeyFrame command wired end‑to‑end; GOP set to 1s)
     - Shorter GOP (I‑frame interval 1s) to speed up decoder lock and reduce black frames after changes (DONE)
  2) Bitrate control + stability
     - End‑to‑end bitrate command (UI → WS → Service → Encoder) (DONE)
     - Clamp bitrate by resolution to avoid encoder stalls/freezes (DONE)
     - UI debounce to avoid thrashing (DONE)
     - Next: basic adaptive downshift if WS send stalls; upshift on recovery
  3) Resilience
     - WS broadcast timeout + drop oldest to avoid head‑of‑line blocking (NEXT)
     - Watchdog to restart encoder/camera on exceptions (NEXT)
  4) Security & Config
     - Add token auth on WS + optional WSS (NEXT)
     - Persist last profile/bitrate/locks (NEXT)
  5) UX & Observability
     - UI status: decoder type (WebCodecs/Broadway), FPS, WS backlog (NEXT)
     - Telemetry enrich: AF/AE strings, drops, encoder fps (NEXT)

Kickoff changes in this sprint:
- New command: requestKeyFrame → triggers MediaCodec sync frame; UI adds “Keyframe” button.
- Encoder: GOP reduced to 1 second; prefer AVC High/Main profiles.
- Bitrate: service clamps by resolution; persists manual value across profile changes.
- Capture tooling: ws_save_h264 waits full DURATION after first keyframe for accurate clip length.

Acceptance (Android sprint 1):
- Reconfig (profile/bitrate/camera switch) yields <1s to first decoded frame and no freezes across 10 runs.
- Bitrate changes visibly affect quality within clamps; no app freeze at highest permitted values.
- UI shows live decoder type and FPS; basic reconnect works (manual reload acceptable in v1).

Open Items / Next Steps
- Stream stability
  - Smooth reconfigure on profile change; handshake between Service and Activity to ensure surfaces are valid before restarting.
  - Improve encoder error handling and backoff; detect stalled pipelines.
- Telemetry enrichment
  - Push AE/AF mode/state strings; surface camera ID, lens facing; add dropped frame counters.
  - Consider throttling or batching telemetry updates.
- Controls
  - Add exposure time/ISO sliders; tap-to-focus; exposure compensation.
  - Persist last-used profile/locks/zoom across sessions.
- UI/Player
  - Small status indicator: decoder in use (WebCodecs/Broadway), FPS, client count.
  - Optional MSE path (mp4 fragments) or WebRTC for broader browser compatibility/latency.
- Recording
  - Add audio path (Mic/AudioRecord + AAC) and mux into MP4; toggle in UI.
  - Filename templating and download helper via ADB pull script.
- Packaging/DevEx
  - Add make targets or Gradle tasks for ADB forward, logs, and capture.
  - CI lint/build workflow; pre-commit hooks for Kotlin/JS formatting.
